<!DOCTYPE html>
<html>
  <head>
    <style>
      body {
        text-align: center;
      }
      .container {
        display: grid;
        gap: 1px;
      }
      .container > div {
        font-size: 1.2rem;
      }
      .box-init {
        background-color: grey;
      }
      .box-open {
        background-color: lightgrey;
      }
      .box-bomb {
        background-color: black;
      }
      .box-flag {
        background-color: red;
      }
    </style>
  </head>
  <body>
    <div class="container"></div>
    <script>
      const LEVEL = {
        easy: {
          cols: 5,
          rows: 5,
          rowBombs: 1,
        },
        normal: {
          cols: 10,
          rows: 10,
          rowBombs: 1,
        },
        hard: {
          cols: 20,
          rows: 20,
          rowBombs: 1,
        },
      };

      const level = LEVEL.hard; // 게임 레벨 지정
      const config = new Config(level); // 게임 환경 설정
      const matrix = new Array(); // 매트릭스 선언

      // 게임 환경 객체
      function Config({ rows, cols, rowBombs }) {
        return {
          rows,
          cols,
          rowBombs,
        };
      }

      // 룸 함수형 객체
      function Box({ node, row, col, bomb = false, flag = false, hint = 0 }) {
        return {
          node,
          row,
          col,
          flag,
          bomb,
          hint,
        };
      }

      // 객체 비 구조화 할당
      const container = document.querySelector('.container');

      initContainer(container);
      initBoxes();
      initBombs();

      console.log(matrix);

      // 컨테이너 아이템 생성
      function initBoxes() {
        for (let i = 0; i < config.rows; i++) {
          let colsArray = new Array(); // 매트릭스 행 배열 초기화
          for (let j = 0; j < config.cols; j++) {
            let node = document.createElement('div', {});
            node.onclick = () => leftClicked(i, j);
            node.oncontextmenu = () => rightClicked(i, j);
            node.className = 'box-init';
            container.appendChild(node);
            colsArray[j] = new Box({ node: node, row: i, col: j });
          }
          matrix[i] = colsArray;
        }
      }

      // 컨테이너 스타일 설정
      function initContainer(container) {
        container.style[
          'grid-template-columns'
        ] = `repeat(${config.cols}, 50px)`;
        container.style['grid-template-rows'] = `repeat(${config.rows}, 50px)`;
      }

      // 폭탄 초기화
      function initBombs() {
        for (let i = 0; i < config.rows; i++) {
          getBombColumns(config.cols, config.rowBombs).forEach((value) => {
            matrix[i][value].bomb = true;
            setBoxAround(i, value, (box) => box.hint++);
          });
        }
      }

      // 박스 주변 설정
      function setBoxAround(row, col, fn) {
        [row - 1, row, row + 1].forEach((r) => {
          if (r >= 0 && r < config.rows) {
            [col - 1, col, col + 1].forEach((c) => {
              c >= 0 && c < config.cols && fn(matrix[r][c]);
            });
          }
        });
      }

      // 폭탄이 설치된 컴럼번호 반환
      function getBombColumns(limit, cnt) {
        let cols = [];
        for (let i = 0; i < cnt; i++) {
          cols.push(Math.floor(Math.random() * 10) % limit);
        }
        console.log('bomb', cols);
        return cols;
      }

      function leftClicked(row, col) {
        const { node, bomb, hint } = matrix[row][col];
        if (bomb) {
          node.className = 'box-bomb';
          alert('폭탄이 터졌습니다. GAME OVER!');
        } else {
          if (hint == 0) {
            setBoxAround(row, col, openBox);
          } else {
            node.innerText = hint;
          }
          node.className = 'box-open';
        }
      }

      function openBox(box) {
        let { node, hint } = box;
        if (node.className == 'box-init') {
          node.className = 'box-open';
          node.innerText = hint > 0 ? hint : '';
        }
      }

      function rightClicked(row, col) {
        let { node, bomb } = matrix[row][col];
        if (node.className == 'box-init') {
          node.className = 'box-flag';
        }
        return false;
      }
    </script>
  </body>
</html>
